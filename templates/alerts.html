{% extends "base.html" %}

{% block title %}Alerts Email{% endblock %}

{% block content %}
<div class="container">
    <h1>Abonnement aux alertes email</h1>
    <p>Inscrivez-vous pour recevoir les alertes sur les vulnérabilités DevSecOps détectées par l'outil.</p>

    <form id="subscribe-form">
        <div class="form-group">
            <label for="email">Adresse email</label>
            <input type="email" id="email" name="email" class="form-control" required placeholder="vous@example.com">
        </div>

        <div class="form-group mt-3">
            <label for="frequency">Type d'alertes</label>
            <select id="frequency" name="frequency" class="form-control">
                <option value="immediate">Immédiate (vulnérabilités critiques)</option>
                <option value="periodic">Rapports périodiques (PDF)</option>
            </select>
        </div>

        <div class="form-group mt-3" id="period-group" style="display: none;">
            <label for="period_days">Période du rapport (en jours)</label>
            <input type="number" id="period_days" name="period_days" class="form-control"
                   min="2" max="30" value="7">
            <small class="form-text text-muted">
                Entre 2 et 30 jours. Le rapport couvrira cette période.
            </small>
        </div>

        <button type="submit" class="btn btn-primary mt-3">S'abonner</button>
    </form>

    <div id="subscribe-message" class="mt-3"></div>
</div>

<script>
const freqSelect = document.getElementById("frequency");
const periodGroup = document.getElementById("period-group");

freqSelect.addEventListener("change", function () {
    if (this.value === "periodic") {
        periodGroup.style.display = "block";
    } else {
        periodGroup.style.display = "none";
    }
});

document.getElementById("subscribe-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const frequency = document.getElementById("frequency").value;
    let period_days = null;
    if (frequency === "periodic") {
        period_days = document.getElementById("period_days").value;
    }

    const resp = await fetch("/api/subscribe-alerts", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ email, frequency, period_days })
    });

    const data = await resp.json();
    const msgDiv = document.getElementById("subscribe-message");
    if (resp.ok && data.status === "success") {
        msgDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        document.getElementById("subscribe-form").reset();
        periodGroup.style.display = "none";
    } else {
        msgDiv.innerHTML = '<div class="alert alert-danger">' + (data.message || "Erreur lors de l\'abonnement") + '</div>';
    }
});
</script>
{% endblock %}
